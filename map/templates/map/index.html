{% load static %}

<!DOCTYPE html>
<html>
  <head>
      <title>Map</title>
      <script src='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.js'></script>
      <script src="https://cdn.jsdelivr.net/npm/translate@1/translate.min.js"></script>
      <link href='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.css' rel='stylesheet' />
      <link rel="stylesheet" href="{% static 'map/style.css' %}">
      <script>
          var embassies = {{ embassy_list|safe }};
          function openPopups(country) {
              var markers = document.getElementsByClassName(`${country}`);
              for (i = 0; i < markers.length; ++i) {
                  if (!markers[i].markerInstance.getPopup().isOpen()){
                      markers[i].markerInstance.togglePopup();
                  }
              }
          };
          //returns a list. first elem: the greatest difference in latitude, second elem: midpoint between two farthest markers
          function getDistanceMidpoint(country) {
              var markers = document.getElementsByClassName(`${country}`);
              var result = 0;
              var midpoint = [markers[0].markerInstance.getLngLat().lng, markers[0].markerInstance.getLngLat().lat];
              for (i = 0; i < markers.length-1; ++i) {
                  for (j = i+1; j < markers.length; ++j) {
                      var firstLat = markers[i].markerInstance.getLngLat().lat;
                      var secondLat = markers[j].markerInstance.getLngLat().lat;
                      var latDif = Math.abs(firstLat - secondLat);
                      if (latDif > result) {
                          result = latDif;
                          var firstLng = markers[i].markerInstance.getLngLat().lng;
                          var secondLng = markers[j].markerInstance.getLngLat().lng;
                          midpoint = [ (firstLng + secondLng)/2, (firstLat + secondLat)/2 ];
                      }
                  }
              }
              return [result, midpoint];
          };
          function center(country) {
              var distAndMid = getDistanceMidpoint(country);
              var distance = distAndMid[0];
              var midpoint = distAndMid[1];
              //varying zoom settings depending on the greatest distance between the markers
              //might chage these later
              var zoomSetting = 6;
              if (distance > 10.0) {
                  zoomSetting = 3;
              }
              else if (distance > 5.0) {
                  zoomSetting = 4;
              }
              map.flyTo({
                  center : midpoint,
                  zoom : zoomSetting,
                  speed : .6,
                  essential: true
              });
              openPopups(country);
          };
          function closePopups(country) {
              var curCountries = document.getElementsByClassName(`${country}`);
              for (j = 0; j < curCountries.length; ++j) {
                  var popup = curCountries[j].markerInstance.getPopup();
                  if (popup.isOpen()) {
                      popup.remove();
                  }
              }
          };
          //closes all existing popups and switches to country
          function switchCountries(oldCountry, newCountry) {
              if (oldCountry !== "") {
                  closePopups(oldCountry);
              }
              center(newCountry);
          };
          //not sure if a global variable is good style
          let countryList = {{countries|safe}};
          function chooseCountry() {
              if (countryList.length === 0) {
                  return "";
              }
              var chosenIndex = Math.floor(Math.random() * countryList.length);
              var chosenCountry = countryList[chosenIndex];
              countryList.splice(chosenIndex, 1);
              return chosenCountry;
          }
          var abort = false; //variable for freestyle loop to stop
          document.addEventListener('DOMContentLoaded', function() {
              document.querySelector('#countryselector').onclick = function() {
                  //closes all popups when the form is resubmitted
                  var allCountries = {{countries|safe}};
                  for (i = 0; i < allCountries.length; ++i) {
                      closePopups(allCountries[i]);
                  }
                  const country = document.querySelector('#countries').value;
                  center(country);
              };
              //loops through each country, zooming into its embassy/consulates.
              //stops when loop is over
              //TO DO: make stop and restart buttons.
              //TO DO: have the loop automatically restart

              document.querySelector('#fsmodebtn').onclick = function() {
                  var old = "";
                  var cur = chooseCountry();
                  function loop() {
                      if (abort) {
                          return;
                      }
                      setTimeout(function() {
                          switchCountries(old, cur);
                          old = cur;
                          cur = chooseCountry();
                          if (cur !== "") {
                              loop();
                          }
                      }, 4000) //this is the time for each loop iteration
                  }
                  loop();
              };
          });
      </script>
  </head>
  <body>
      <h1 style="font-family: Courier New, Courier, monospace; font-size: 40px; padding-left: 5px">Welcome to our<span style="font-family: Brush Script MT; font-size: 55px; letter-spacing: 2.5px;"> interactive map</span></h1>
      <form id="countryform">
          <label style="font-family: Courier New, Courier, monospace; padding-left: 5px">Which country would you like to explore?</label>
          <select id="countries" name="countries">
              {% for country in countries %}
                  <option value="{{country}}">{{country}}</option>
              {% endfor %}
          </select>
          <input id="countryselector" type="button" value="Submit">
      </form>
      <button id="fsmodebtn">Freestyle Mode</button>
      <button id="stopbtn" onclick="abort = true">Stop</button>
      <div id='map' style='width: 1400px; height: 750px;'></div>
      <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
      <script>
          mapboxgl.accessToken = 'pk.eyJ1IjoiZXNpbnlhdmluIiwiYSI6ImNrY3F0b2E0eDE2dWUycm8ycnZiaWFnMGoifQ.fNIknam7PYZohKbgfigHvA';
          var map = new mapboxgl.Map({
            pitch:0.01,
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [35.385076, 36.983267],
            zoom: 2
          });

          var langs = JSON.parse('{{ lang_list|safe }}');
          var title = '<h3>Learn more about this embassy!<h3>';
          var embassies = {{ embassy_list|safe }};
          for(var i = 0; i < 275; i++) {
              props = embassies[i];


              /*var l = document.createElement('div');
              l.className = 'custom-marker';
                l.style.backgroundImage ='url({% static "map/man.svg" %})';
                l.style.width = "60px";
                l.style.height = "60.23px";
                let tmpMarker2 = new mapboxgl.Marker(l);*/
              var description ='<p>' + props[3]+ '</p>'; //city name
              if (props[0] !== "Active") {
                  continue;
              }
              //commented out code is for adding background image
              var el = document.createElement('div');
              var btn = '<div style="margin: 0 auto; width: 110px; text-align: center; cursor: pointer; background-color: black" onclick="myfunc('+props[13]+')"><p style="color: white">Play Language</p></div>'

              function myfunc(x){
                  var msg = new SpeechSynthesisUtterance();
                    msg.text = langs[x].word;
                    msg.lang = langs[x].language;
                    //window.alert(msg.lang);
                    window.speechSynthesis.speak(msg);
              }

              el.style.backgroundImage = 'url(https://i.pinimg.com/564x/f4/a8/6a/f4a86a209ba10ab95afcfd4ed29f3acf.jpg)';
              el.style.width = '15px';
              el.style.height = '15px';
              el.style.borderRadius = '50%';
              el.style.border = '0.25px solid';

              //var marker = new mapboxgl.Marker().setLngLat([props[14],props[13]]).addTo(map);
              let tmpMarker = new mapboxgl.Marker(el);
              el.markerInstance = tmpMarker;
              tmpMarker.setLngLat([props[14],props[13]]).setPopup(new mapboxgl.Popup({ offset: 25 }) // add popups
                .setHTML('<h3>' + title + '</h3><p>' + description + '</p>'+ '<img src="https://flagcdn.com/w320/af.png"  alt="Afghanistan flag" width = "40" height="40">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/af.png" alt="Afghanistan_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/al.png" alt="Albania_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ad.png" alt="Andorra_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/am.png" alt=" Armenia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ao.png" alt="Angola_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/aq.png" alt="Antarctica" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ar.png" alt="Argentina_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/at.png" alt="Austria_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/au.png" alt="Australia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/az.png" alt="Azerbaijan_flag" width = "60" height="60">')).addTo(map
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/bs.png " alt="Bahamas_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/bh.png" alt="Bahrain_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/bd.png" alt="Bangladesh_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/bb.png" alt="Barbados_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/by.png " alt="Belarus_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/be.png" alt="Belgium_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/bz.png" alt="Belize_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/bj.png " alt="Benin_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/bm.png"  alt="Bermuda_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/bt.png " alt="Bhutan_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/bo.png" alt="Bolivia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ba.png" alt="Bosnia and Herzegovina_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/bw.png"  alt="Botswana_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/br.png " alt="Brazil_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/bn.png " alt="Brunei_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/bg.png" alt="Bulgaria_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/bf.png" alt="Burkina Faso_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/bi.png  " alt="Burundi_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/cv.png " alt="Cape Verde_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/cm.png " alt="Cameroon_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ca.png " alt="Canada_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/cf.png " alt="Central African Republic_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/cl.png " alt="Chile_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/cn.png " alt="China_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/co.png " alt="Colombia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/cr.png " alt="Costa Rica_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ci.png" alt="Côte dIvoire_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/cu.png " Cuba_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/cw.png " Curaçao_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/cy.png"  Cyprus_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/cz.png " Czechia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/dk.png"  Denmark_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/dj.png " Djibouti_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/dm.png"  Dominica_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/do.png"  Dominican Republic_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ec.png " Ecuador_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/eg.png " Egypt_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/er.png " Eritrea_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ee.png"  Estonia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/et.png " Ethiopia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/fj.png"  Fiji_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/fi.png"  Finland_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/fr.png " France_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ga.png " Gabon_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/gm.png"  Gambia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ge.png " Georgia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/de.png " Germany_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/gh.png " Ghana_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/gr.png" Greece_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/gd.png "  Grenada_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/gt.png  " Guatemala_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/gw.png" Guinea-Bissau_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/gy.png"  Guyana_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ht.png  " Haiti_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/hn.png  " Honduras_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/hk.png " Hong Kong_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/hu.png " Hungary_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/is.png"  Iceland_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/in.png  " India_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/id.png " Indonesia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ir.png  " Iran_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/iq.png"  Iraq_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ie.png  " Ireland_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/il.png  " Israel_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/it.png  " Italy_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/jm.png  " Jamaica_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/jp.png " Japan_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/jo.png"  Jordan_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/kz.png"  Kazakhsta_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ke.png " Kenya_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ki.png " Kiribati_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/kr.png"  South Korea_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/kw.png"  Kuwait_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/kg.png  " Kyrgyzstan_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/la.png"  Laos_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/lv.png " Latvia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/lb.png"  Lebanon_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ls.png " Lesotho_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/lr.png " Liberia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ly.png"  Libya_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/li.png " Liechtenstein_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/lt.png " Lithuania_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/lu.png "> Luxembourg_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/mg.png">  Madagascar_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/mw.png"> Malawi_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/my.png">  Malaysia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/mv.png "> Maldives_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ml.png "> Mali_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/mt.png "> Malta_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/mh.png "> Marshall Islands_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/mr.png "> Mauritania_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/mu.png "> Mauritius_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/mx.png">  Mexico_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/md.png">  Moldova_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/mc.png "> Monaco_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/mn.png "> Mongolia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/me.png "> Montenegro_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ma.png "> Morocco_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/mz.png">  Mozambique_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/na.png">  Namibia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/nr.png">  Nauru_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/np.png "> Nepal_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/nl.png "> Netherlands_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/nz.png "> New Zealand_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ni.png "> Nicaragua_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ne.png "> Niger_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ng.png">  Nigeria_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/no.png "> Norway_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/om.png "> Oman_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/pk.png">  Pakistan_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/pw.png "> Palau_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ps.png">  Palestine_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/pa.png "> Panama_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/pg.png "> Papua New Guinea_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/py.png "> Paraguay_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/pe.png">  Peru_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ph.png "> Philippines_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/pl.png">  Poland_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/pt.png "> Portugal_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/qa.png "> Qatar_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ro.png "> Romania_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ru.png "> Russia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/rw.png "> Rwanda_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/sm.png  "> San Marino" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/st.png">  São Tomé and Príncipe_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/sa.png "> Saudi Arabia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/sn.png "> Senegal_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/sc.png">  Seychelles_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/sl.png "> Sierra Leone_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/sg.png">  Singapore_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/sk.png">  Slovakia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/si.png">  Slovenia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/sb.png "> Solomon Islands_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/so.png">  Somalia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ss.png "> South Sudan_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/sd.png">  Sudan_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/sr.png">  Suriname_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/se.png">  Sweden_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/sy.png "> Syria_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/tw.png "> Taiwan_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/tj.png "> Tajikistan_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/tz.png "> Tanzania_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/tg.png "> Thailand_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/tl.png "> Timor-Leste_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/tg.png "> Togo_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/to.png "> Tonga_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/tt.png "> Trinidad and Tobago_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/tn.png "> Tunisia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/tr.png "> Turkey_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/tm.png "> Turkmenistan_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/tv.png "> Tuvalu_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ug.png">  Uganda_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ua.png">  Ukraine_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ae.png" >United Arab Emirates_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/uy.png  "> Uruguay_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/uz.png">  Uzbekistan_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/vu.png">  Vanuatu_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/vn.png">  Vietnam_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ye.png">  Yemen_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/zm.png">  Zambia_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/zw.png">  Zimbabwe_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/za.png">  South Africa_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/ve.png">  Venezuela_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/vc.png "> Saint Vincent and the Grenadines_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/va.png "> Vatican City_flag" width = "60" height="60">')).addTo(map);
                .setHTML(title +  description + '<img src="https://flagcdn.com/w320/vn.png">  Vietnam_flag" width = "60" height="60">')).addTo(map);



              var title = '';
              if (props[5] === 'OFFOBC') {
                  title = `US Embassy in ${description}.`;
              }
              else if (props[5] === 'OFFCOB') {
                  title = `US Consulate in ${description}.`;
              }
              else if (props[5] === 'OFFOBX'){
                  title = `Annex building in ${description}.`;
              }
              else if (props[5] === 'OFFCAX' || props[5] === 'OFFAPP') {
                  title = `US Embassy branch office in ${description}`;
              }
              else {
                  title = `${props[2]}.`; //just to be safe -- change later
              }

              tmpMarker.setLngLat([props[14],props[13]]).setPopup(new mapboxgl.Popup({ offset: 25 }) // add popups
                .setHTML(title +  description + btn)).addTo(map);

              el.addEventListener("click", e => {
                  // here's where I can use the "markerInstance" I added earlier to then expose the getLngLat
                  let coords = e.target.markerInstance.getLngLat();
              //l.markerInstance = tmpMarker2;
                //tmpMarker2.setLngLat(coords).addTo(map);
                  //tell the map to center on the marker coordinates
                  map.flyTo({
                      center: coords,
                      speed: 0.6,
                      zoom: 6
                  });

              });

              //TO DO: find a way to add it to popup, not replaces the html already there!
              $.ajax({
                  url: '{% url "get_news" %}',
                  data: {
                    'country': `${props[2]}`
                  },
                  dataType: 'json',
                  success: function (data) {
                      tmpMarker.getPopup().setText(data.article_list.toString());
                      //var cur = tmpMarker.getPopup().getElement();
                      //tmpMarker.getPopup().setHTML(`${cur}<p>${data.article_list.toString()}</p>`);
                  }
              });

          }
      </script>

      <h1>Time</h1>
      <h1 id="time"></h1>

      <div id='map2' style='width: 1000px; height: 670px;'></div>
      <script>
          var counter = 0;

          // Tell user if the embassy is open
          function isOpen(start, end, time){
              if(start < end){
                  if(start <= time && time < end){
                      return true;
                  }
                  else{
                      return false
                  }
              }
              else{
                  if(start <= time || time < end){
                      return true;
                  }
                  else{
                      return false;
                  }
              }
          }


          mapboxgl.accessToken = 'pk.eyJ1IjoiZXNpbnlhdmluIiwiYSI6ImNrY3F0b2E0eDE2dWUycm8ycnZiaWFnMGoifQ.fNIknam7PYZohKbgfigHvA';
          var map2 = new mapboxgl.Map({
            container: 'map2',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [0,0],
            zoom: 1

          });

          map2.scrollZoom.disable();

          var geojson = {
            type: 'FeatureCollection',
            features: [{
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [-77.032, 38.913]
                },
                properties: {
                    title: 'Mapbox',
                    description: 'Washington, D.C.',
                    openHour: 0,
                    closeHour: 12,
                }
            },
            {
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [-122.414, 37.776]
                },
                properties: {
                    title: 'Mapbox',
                    description: 'San Francisco, California',
                    openHour: 15,
                    closeHour: 3,
                }
            }]
          };

            var markerLst = []
            geojson.features.forEach(function(marker) {

                // make a marker for each feature and add to the map
                //var m = new mapboxgl.Marker(el)
                //.setLngLat(marker.geometry.coordinates)
                //.addTo(map2);
                var color = "#ff0000";        // Color red for close
                if(isOpen(marker.properties.openHour, marker.properties.closeHour, counter)){
                    // Color green for open
                    color = "#008000"
                }

                markerLst.push(
                    new mapboxgl.Marker({color: color, "icon-size": "0.5"})
                    .setLngLat(marker.geometry.coordinates)
                    .addTo(map2));
            });

            window.setInterval(function test(){
                counter = (counter + 1) % 24;
                if(counter == 0){
                    document.getElementById('time').textContent = "12:00 AM";
                }
                else if(counter < 12){
                    document.getElementById('time').textContent = counter.toString() + ":00 AM";
                }
                else if(counter >= 12){
                    document.getElementById('time').textContent = (counter % 12) == 0 ? "12:00 PM" : (counter % 12).toString() + ":00 PM";
                }

                markerLst.forEach((m) => {
                    m.remove();
                });
                markerLst = [];
                geojson.features.forEach(function(marker) {
                    var color = "#ff0000";        // Color red for close
                    if(isOpen(marker.properties.openHour, marker.properties.closeHour, counter)){
                        // Color green for open
                        color = "#008000"
                    }

                    markerLst.push(
                        new mapboxgl.Marker({color: color, "icon-size": "0.5"})
                        .setLngLat(marker.geometry.coordinates)
                        .addTo(map2));
                });

            }, 1000);

      </script>

      <h1>News</h1>
        <ul>
            {% for article in articles %}
                <li>{{ article.2 }}</li>
                <ul>
                    <li><a href={{ article.1 }}> {{ article.0 }} </a></li>
                </ul>
            {% endfor %}
        </ul>
  </body>
</html>
