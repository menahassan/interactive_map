{% load static %}

<!DOCTYPE html>
<html>
  <head>
      <title>Map</title>
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
      <script src='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.js'></script>
      <script src="https://cdn.jsdelivr.net/npm/translate@1/translate.min.js"></script>
      <link href='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.css' rel='stylesheet' />
      <link rel="stylesheet" type="text/css" href="{% static 'map/styles.css' %}">
      <script>
        var embassies = {{ embassy_list|safe }};

          function openPopups(country) {
              var markers = document.getElementsByClassName(`${country}`);
              for (i = 0; i < markers.length; ++i) {
                  if (!markers[i].markerInstance.getPopup().isOpen()){
                      markers[i].markerInstance.togglePopup();
                  }
              }
          };
          function openOnePopup(country) {
              var marker = document.getElementById(`${country}`);
              if (!marker.markerInstance.getPopup().isOpen()){
                  marker.markerInstance.togglePopup();
              }
              marker.markerInstance.getPopup().closeOnClick = false;
          };
          //returns a list. first elem: the greatest difference in latitude, second elem: midpoint between two farthest markers
          function getDistanceMidpoint(country) {
              var markers = document.getElementsByClassName(`${country}`);
              var result = 0;
              var midpoint = [markers[0].markerInstance.getLngLat().lng, markers[0].markerInstance.getLngLat().lat];
              for (i = 0; i < markers.length-1; ++i) {
                  for (j = i+1; j < markers.length; ++j) {
                      var firstLat = markers[i].markerInstance.getLngLat().lat;
                      var secondLat = markers[j].markerInstance.getLngLat().lat;
                      var latDif = Math.abs(firstLat - secondLat);
                      if (latDif > result) {
                          result = latDif;
                          var firstLng = markers[i].markerInstance.getLngLat().lng;
                          var secondLng = markers[j].markerInstance.getLngLat().lng;
                          midpoint = [ (firstLng + secondLng)/2, (firstLat + secondLat)/2 ];
                      }
                  }
              }
              return [result, midpoint];
          };
          function center(country) {
              var distAndMid = getDistanceMidpoint(country);
              var distance = distAndMid[0];
              var midpoint = distAndMid[1];
              //varying zoom settings depending on the greatest distance between the markers
              //might chage these later
              var zoomSetting = 6;
              if (distance > 10.0) {
                  zoomSetting = 3;
              }
              else if (distance > 5.0) {
                  zoomSetting = 4;
              }
              map.flyTo({
                  center : midpoint,
                  zoom : zoomSetting,
                  speed : .6,
                  essential: true
              });
              openPopups(country);
          };
          function closePopups(country) {
              var curCountries = document.getElementsByClassName(`${country}`);
              for (j = 0; j < curCountries.length; ++j) {
                  var popup = curCountries[j].markerInstance.getPopup();
                  if (popup.isOpen()) {
                      popup.remove();
                  }
              }
          };
          //closes all existing popups and switches to country
          function switchCountries(oldCountry, newCountry) {
              if (oldCountry !== "") {
                  closePopups(oldCountry);
              }
              center(newCountry);
          };
          //not sure if a global variable is good style
          let countryList = {{countries|safe}};
          function chooseCountry() {
              if (countryList.length === 0) {
                  return "";
              }
              var chosenIndex = Math.floor(Math.random() * countryList.length);
              var chosenCountry = countryList[chosenIndex];
              countryList.splice(chosenIndex, 1);
              return chosenCountry;
          };

          function openIssue(country) { //delete / move to another doc
              var curCountries = document.getElementsByClassName(`${country}`);
              for (j = 0; j < curCountries.length; ++j) {
                  var popup = curCountries[j].markerInstance.getPopup();
                  if (!((popup.innerHTML).indexOf("No US Diplomatic Presence") !== -1 || (popup.innerHTML).indexOf("Embassy") !== -1)) {
                     //has neither of these strings
                     continue;
                  }
                  if (!popup.isOpen()){
                      popup.togglePopup();
                  }
                  //to do: use popup or marker element to do the following
                  var elems = document.getElementsByClassName(`issuebtn${country}`);
                  for (i = 0; i < elems.length; ++i) {
                      elems[i].style.visibility = 'visible';
                  }
                  elems = document.getElementsByClassName(`issueparagraph${country}`);
                  for (i = 0; i < elems.length; ++i) {
                      elems[i].style.visibility = 'visible';
                  }
              }
          };
          function setPopupText(list, param) {
              var str = ``;
              for (n=0; n<list.length; ++n) {
                 str = str.concat(`<p>\"${list[n][0]}\"<br>${list[n][1]}<br>${list[n][2]}<br>Link: ${list[n][3]}</p>`);
              }
              param.content = str;
          };

          //probably can combine these two to avoid repetition
          function sendAjaxIssue(country, issue, text, units, dataPoint) { //delete
            var parag = {content: ''};
            $.ajax({
                url: '{% url "map:get_news_issue" %}',
                data: {
                  'country': country,
                  'issue' : issue
                },
                async: false,
                dataType: 'json',
                success: function (data) {
                    setPopupText(data.article_list, parag);
                    var popupElem = document.getElementById(`${country}`).markerInstance.getPopup().setHTML(
                      `<h3>${country}</h3>` + parag.content + `<p>${text}${dataPoint}${units}</p>`+
                      `<img src="" alt="My image" width = "40" height="40">`
                    );

                }
            });
          };
          var issuesSummaries = {{ issues_summaries|safe }};

          var abort = false; //variable for freestyle loop to stop
          document.addEventListener('DOMContentLoaded', function() {
              var allCountries = {{countries|safe}};
              document.querySelector('#countryselector').onclick = function() {
                  //closes all popups when the form is resubmitted
                  for (i = 0; i < allCountries.length; ++i) {
                      closePopups(allCountries[i]);
                  }
                  const country = document.querySelector('#countries').value;
                  center(country);
              };

              document.querySelector('#issueselector').onclick = function() {
                  for (i = 0; i < allCountries.length; ++i) {
                      closePopups(allCountries[i]);
                  }
                  map.flyTo({
                      center: [12.550343, 55.665957],
                      zoom: 2
                  });
                  const issue = document.querySelector('#issues').value;
                  document.getElementById('header').innerHTML = `${issue}`;
                  var text = '';
                  var units = '';
                  for (i=0; i < issuesSummaries.length; ++i) {
                      if (issuesSummaries[i][0] === issue) {
                          document.getElementById('description').innerHTML = `${issuesSummaries[i][1]}`;
                          units = issuesSummaries[i][2];
                          text = issuesSummaries[i][3];
                      }
                  }

                  //TO DO: issuedict will be a dict of issues with corresponding list of countries related to it
                  //const issues = JSON.parse({{ issuedict }});

                  //TO DO: add all countries to nodiplpresencelist
                  //TO DO: find a way to use the selected issue to choose template variable

                  var list = {{ airpollution|safe }};//create if statements to assign list to appropriate template
                  for (i = 0; i < list.length; ++i) {
                      var country = list[i][0];
                      var dataPoint = list[i][1];
                      openOnePopup(country);
                      sendAjaxIssue(country, issue, text, units, dataPoint);
                  }

              };
              //loops through each country, zooming into its embassy/consulates.
              //stops when loop is over
              //TO DO: make stop and restart buttons.
              //TO DO: have the loop automatically restart

              document.querySelector('#fsmodebtn').onclick = function() {
                  var old = "";
                  var cur = chooseCountry();
                  function loop() {
                      if (abort) {
                          return;
                      }
                      setTimeout(function() {
                          switchCountries(old, cur);
                          old = cur;
                          cur = chooseCountry();
                          if (cur !== "") {
                              loop();
                          }
                      }, 10000) //this is the time for each loop iteration
                  }
                  loop();
              };
          });
      </script>
  </head>
  <body>
      <h1 id='header'>United States Diplomatic Presence Worldwide</h1>
      <p id='description'>
        With 274 embassies, consulates, and other diplomatic missions around the globe,
        the United States boasts the greatest diplomatic presence of any country.
        To learn more about our bilateral relations with each country as well as the countries of focus
        in solving the most pressing global issues.
      </p>
      <h1 style="font-family: Courier New, Courier, monospace; font-size: 40px; padding-left: 5px">Explore global issues:!</h1>
      <div style="font-family: Courier New, Courier, monospace; display: inline-block; width: 110px; text-align: center; cursor: pointer; background-color: #4a57ed">
        <a href="{% url 'data:demo' %}"><div style="color: white; margin: 10px 10 px;">World Population Data</div></a>
        <a href="{% url 'map:hdiMap' %}"><div style="color: white; margin: 10px 10 px;">World Human Develop Index Time Lapse</div></a>
        <a href="{% url 'map:embassyYearOpen' %}"><div style="color: white; margin: 10px 10 px;">United State's Embassy Time Lapse</div></a>
    </div>
      <form id="countryform">
          <label>Explore a country: </label>
          <select id="countries" name="countries">
              {% for country in countries %}
                  <option value="{{country}}">{{country}}</option>
              {% endfor %}
          </select>
          <input id="countryselector" type="button" value="Explore!">
      </form>
      <form id="issueform">
          <label>Or a global issue: </label>
          <select id="issues" name="issues">
              <option value="Air pollution">Air pollution</option>
          </select>
          <input id="issueselector" type="button" value="Explore!">
      </form>
    
      <button id="fsmodebtn">Freestyle Mode</button>
      <button id="stopbtn" onclick="abort = true">Stop</button>
      <form class="link" action="airpollution.html">
          <input type="submit" value="airpollution">
      </form>
      <div id='map' style='width: 100%; height: 750px; '></div>
      <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
      <script>
          mapboxgl.accessToken = 'pk.eyJ1IjoiZXNpbnlhdmluIiwiYSI6ImNrY3F0b2E0eDE2dWUycm8ycnZiaWFnMGoifQ.fNIknam7PYZohKbgfigHvA';
          var map = new mapboxgl.Map({
            pitch:0.01,
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [35.385076, 36.983267],
            zoom: 2
          });
          //map.scrollZoom.disable();
          //var marker = new mapboxgl.Marker().setLngLat([12.550343, 55.665957]).addTo(map);
          var embassies = {{ embassy_list|safe }};
          var countries = {{ countries|safe }};
          //console.log(countries.toString()); //delete!
          const countriesNoDiplPresence = {{ nodiplpresencelist|safe }};
          for (var i = 0; i < countriesNoDiplPresence.length; i++) {
              var props = countriesNoDiplPresence[i];
              var country = props[0];

              var parag = {content: ''};

              $.ajax({
                  url: '{% url "map:get_news" %}',
                  data: {
                    'country': country
                  },
                  async: false,
                  dataType: 'json',
                  success: function (data) {
                      setPopupText(data.article_list, parag);
                  }
              });

              var el = document.createElement('div');
              el.className = `${country}`;
              el.id = `${country}`;
              el.style.width = '15px';
              el.style.height = '15px';
              el.style.borderRadius = '50%';
              el.style.border = '0.25px solid';
              el.style.backgroundColor = 'rgb(72, 61, 139)';
              //el.style.color = 'blue';
              let tmpMarker = new mapboxgl.Marker(el);
              el.markerInstance = tmpMarker;

              //TO DO: how to make these markers present for issues
              //TO DO: should we add countries with no dipl presence to main menu?
              //TO DO: make spreadsheet with all countries and lat/long and use it instead of countries template var
              tmpMarker.setLngLat([props[2],props[1]]).setPopup(new mapboxgl.Popup({ offset: 25 }) // add popups
                .setHTML(`<h3 class="title${country}">No US Diplomatic Presence</h3><p>${country}</p>` +
                parag.content +
                `<img src="" alt="My image" width = "40" height="40">`)).addTo(map);
              el.addEventListener("click", e => {
                  // here's where I can use the "markerInstance" I added earlier to then expose the getLngLat
                  let coords = e.target.markerInstance.getLngLat();
                  //tell the map to center on the marker coordinates
                  map.flyTo({
                      center: coords,
                      speed: 0.6,
                      zoom: 5
                  });
              });

          }
          var supportedLangs = ["en","de","es","fr","hi","id","it","ja","ko","nl","pl",
                "pt","ru","zh-cn","zh-tw","uz","cs","bs","ro","sq","hr","az","hu"]
            var langs = JSON.parse('{{ lang_list|safe }}');
          for(var i = 0; i < embassies.length; i++) {
              props = embassies[i];
              if (props[0] !== "Active") {
                  continue;
              }
              var el = document.createElement('div');

              var parag = {content: ''};
              if (document.getElementsByClassName(`${props[2]}`).length === 0) { //first emb/cons of a given country
                  //parag = `<p id='parag${props[2]}'></p>`
                  $.ajax({
                      url: '{% url "map:get_news" %}',
                      data: {
                        'country': props[2]
                      },
                      async: false,
                      dataType: 'json',
                      success: function (data) {
                          setPopupText(data.article_list, parag); //passing by reference
                      }
                  });

                  el.id = props[2].toString();
              }
              //commented out code is for adding background image
              el.className = props[2].toString(); //used to be set to 'marker'
              //red box image
              //var marker = new mapboxgl.Marker().setLngLat([props[14],props[13]]).addTo(map);
              var title = '';
              var city = props[3]; //city name
              if (props[5] === 'OFFOBC') {
                  title = `US Embassy in ${city}.`;
              }
              else if (props[5] === 'OFFCOB') {
                  title = `US Consulate in ${city}.`;
              }
              else if (props[5] === 'OFFOBX'){
                  title = `Annex building in ${city}.`;
              }
              else if (props[5] === 'OFFCAX' || props[5] === 'OFFAPP') {
                  title = `US Embassy branch office in ${city}`;
            }
              
              
              var btn = '<div style="margin: 0 auto; width: 110px; text-align: center; cursor: pointer; background-color: black" onclick="myfunc('+props[13]+')"><p style="color: white">Play Language</p></div>'

              function myfunc(x){
                  var msg = new SpeechSynthesisUtterance(); 
                    msg.text = langs[x].word;
                    msg.lang = langs[x].language;
                    if(!supportedLangs.includes(langs[x].language)){
                        window.alert("Sorry! "+ langs[x].langFull.toString() + " is not currently supported.");
                    }
                    else{
                        window.speechSynthesis.speak(msg);
                    }
                    //window.alert(msg.lang);
              }
              el.style.backgroundImage = 'url(https://i.pinimg.com/564x/f4/a8/6a/f4a86a209ba10ab95afcfd4ed29f3acf.jpg)';
              el.style.width = '15px';
              el.style.height = '15px';
              el.style.borderRadius = '50%';
              el.style.border = '0.25px solid';
              
              //var marker = new mapboxgl.Marker().setLngLat([props[14],props[13]]).addTo(map);
              let tmpMarker = new mapboxgl.Marker(el);
              el.markerInstance = tmpMarker;
                tmpMarker.setLngLat([props[14],props[13]]).setPopup(new mapboxgl.Popup({ offset: 25 }) // add popups
                .setHTML(`<h3 class="title${country}">` + title + `</h3><p>${props[2]}</p>` +
                parag.content +
                `<img src="" alt="My image" width = "40" height="40">` + btn)).addTo(map);
                

              el.addEventListener("click", e => {
                  // here's where I can use the "markerInstance" I added earlier to then expose the getLngLat
                  let coords = e.target.markerInstance.getLngLat();
              //l.markerInstance = tmpMarker2;
                //tmpMarker2.setLngLat(coords).addTo(map);
                  //tell the map to center on the marker coordinates
                  map.flyTo({
                      center: coords,
                      speed: 0.6,
                      zoom: 6
                  });
                  
              });
              
          }

      </script>

      <p id="latestnews"> <!--where news will show up :: DELETE-->
  </body>
</html>