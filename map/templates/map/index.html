{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
      <title>Map</title>
      <script src='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.js'></script>
      <link href='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.css' rel='stylesheet' />
      <link rel="stylesheet" type="text/css" href="{% static 'map/style.css' %}">
      <script>
          function center() { //doesnt work; page refreshes when pin is set -->
              country = {{country}}
              //map.center = [69.190028, 34.534618];-->
              //set to afghanistan; will have to extract location from excel -->
          }
          
      </script>
  </head>
  <body>
      <h1>Hello world! This is our interactive map</h1>
      <form id="countryform" action="" method="post">
          {% csrf_token %}
          {{ form.as_p }}
          <p><input type="submit" value="Submit" onclick="center()"></p>
      </form> 

        
    <div id='map' style='width: 100%; height: 670px;'></div>
      <script>
          mapboxgl.accessToken = 'pk.eyJ1IjoiZXNpbnlhdmluIiwiYSI6ImNrY3F0b2E0eDE2dWUycm8ycnZiaWFnMGoifQ.fNIknam7PYZohKbgfigHvA';
          var map = new mapboxgl.Map({
            pitch:0.01,
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [35.385076, 36.983267],
            zoom: 2
          });
        
          //var marker = new mapboxgl.Marker().setLngLat([12.550343, 55.665957]).addTo(map);                                  
          var embassies = {{ embassy_list|safe }};
          for(var i = 0; i < 275; i++){
            props = embassies[i];
            var title = 'Learn more about this embassy!';
            var description = props[3];
            //commented out code is for adding background image
            var el = document.createElement('div'); 
            el.class = 'marker'; 
            //red box image                                     
            el.style.backgroundImage = 'url(https://i.pinimg.com/564x/f4/a8/6a/f4a86a209ba10ab95afcfd4ed29f3acf.jpg)';              
            el.style.width = '15px';                                                      
            el.style.height = '15px';
            el.style.borderRadius = '50%';
            el.style.border = '0.25px solid';
            //var marker = new mapboxgl.Marker().setLngLat([props[14],props[13]]).addTo(map); 
            let tmpMarker = new mapboxgl.Marker(el);
            el.markerInstance = tmpMarker;
            tmpMarker.setLngLat([props[14],props[13]]).setPopup(new mapboxgl.Popup({ offset: 25 }) // add popups
    .setHTML('<h3>' + title + '</h3><p>' + description + '</p>')).addTo(map);
            el.addEventListener("click", e => {
              // here's where I can use the "markerInstance" I added earlier to then expose the getLngLat
              let coords = e.target.markerInstance.getLngLat();
              //tell the map to center on the marker coordinates
              map.flyTo({
                  center: coords,
                  speed: 0.6,
                  zoom: 5
              });
          });
          }
      </script>
  </body>
</html>
