{% load static %}

<!DOCTYPE html>
<html>
  <head>
      <title>Map</title>
      <script src='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.js'></script>
      <script src="https://cdn.jsdelivr.net/npm/translate@1/translate.min.js"></script>
      <link href='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.css' rel='stylesheet' />
      <link rel="stylesheet" href="{% static 'map/style.css' %}">
      <script>
          var cur_country = "";
          function toggleMarkers(country){
              var markers = document.getElementsByClassName(`${country}`);
              for (i = 0; i < markers.length; ++i) {
                  markers[i].markerInstance.togglePopup();
              }
          };
          function center(country) {
              var my_dict = JSON.parse('{{ dict|safe }}');
              var longitude = my_dict[country].long;
              var latitude = my_dict[country].lat;
              var longlat = [longitude, latitude];
              map.flyTo({
                  center : longlat,
                  zoom : 3,
                  essential: true
              });
              toggleMarkers(country);
          };
          document.addEventListener('DOMContentLoaded', function() {
              document.querySelector('#countryselector').onclick = function() {
                  if (cur_country !== "") {
                      toggleMarkers(cur_country);
                  }
                  const country = document.querySelector('#countries').value;
                  cur_country = country;
                  center(country);
              };
          });
      </script>
  </head>
  <body>
      <h1 style="font-family: Courier New, Courier, monospace; font-size: 40px; padding-left: 5px">Welcome to our<span style="font-family: Brush Script MT; font-size: 55px; letter-spacing: 2.5px;"> interactive map</span></h1>
      <form id="countryform">
          <label style="font-family: Courier New, Courier, monospace; padding-left: 5px">Which country would you like to explore?</label>
          <select id="countries" name="countries">
              {% for country in countries %}
                  <option value="{{country}}">{{country}}</option>
              {% endfor %}
          </select>
          <input id="countryselector" type="button" value="Submit">
      </form>
    <div id='map' style='width: 100%; height: 670px;'></div>
      <script>
          mapboxgl.accessToken = 'pk.eyJ1IjoiZXNpbnlhdmluIiwiYSI6ImNrY3F0b2E0eDE2dWUycm8ycnZiaWFnMGoifQ.fNIknam7PYZohKbgfigHvA';
          var map = new mapboxgl.Map({
            pitch:0.01,
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [35.385076, 36.983267],
            zoom: 2
          });
          
          var langs = JSON.parse('{{ lang_list|safe }}');
          var title = '<h3>Learn more about this embassy!<h3>';
          var embassies = {{ embassy_list|safe }};
          for(var i = 0; i < 275; i++){
              props = embassies[i];
              

              /*var l = document.createElement('div');
              l.className = 'custom-marker';
                l.style.backgroundImage ='url({% static "map/man.svg" %})';
                l.style.width = "60px";
                l.style.height = "60.23px";
                let tmpMarker2 = new mapboxgl.Marker(l);*/
              var description ='<p>' + props[3]+ '</p>';
              var el = document.createElement('div');

              el.style.backgroundImage = 'url(https://i.pinimg.com/564x/f4/a8/6a/f4a86a209ba10ab95afcfd4ed29f3acf.jpg)';
              el.style.width = '15px';
              el.style.height = '15px';
              el.style.borderRadius = '50%';
              el.style.border = '0.25px solid';
              
              //var marker = new mapboxgl.Marker().setLngLat([props[14],props[13]]).addTo(map);
              let tmpMarker = new mapboxgl.Marker(el);
              el.markerInstance = tmpMarker;
              tmpMarker.setLngLat([props[14],props[13]]).setPopup(new mapboxgl.Popup({ offset: 25 }) // add popups
                .setHTML(title +  description + '<img src="{% static "map/embassy-1.jpg" %}" alt="My image" width = "60" height="60">')).addTo(map);
                

              el.addEventListener("click", e => {
                  // here's where I can use the "markerInstance" I added earlier to then expose the getLngLat
                  let coords = e.target.markerInstance.getLngLat();
                  var msg = new SpeechSynthesisUtterance();
                  msg.text = langs[coords.lat].word;
                  msg.lang = langs[coords.lat].language;
                  window.alert(msg.text);
                  window.speechSynthesis.speak(msg);
              //l.markerInstance = tmpMarker2;
                //tmpMarker2.setLngLat(coords).addTo(map);
                  //tell the map to center on the marker coordinates
                  map.flyTo({
                      center: coords,
                      speed: 0.6,
                      zoom: 6
                  });
              });
          }
      </script>
  </body>
</html>
